<!DOCTYPE html>
<html lang="en">

  <head>
      <title>Admin Page</title>
      <link rel="stylesheet" href="./css/twicon/twicon.css">
      <link rel="stylesheet" type="text/css" href="./css/admin.css">
      <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
  </head>

  <body>

    <header>
      <div class="logo">
        <a href="./admin.html">Politician Track
          <!-- <i class="twicon-recycling"></i> -->
          <!-- <img src="imgs/logo.png" alt="logo"> -->
        </a>
      </div>
      <nav>
        <div class="item">
          <a href="./admin.html">後台</a>
        </div>
      </nav>

    </header>



    <main>

      <div class="view">
        <div class="heading">
          <h3>斷詞時間範圍</h3>

          <div class="period">
            <div class="dateGroup">
              <div class="dateTitle">開始：</div>
              <input class="date" type="date" id="date_start">
            </div>
            <div class="dateGroup">
              <div class="dateTitle">結束：</div>
              <input class="date" type="date" id="date_end">
            </div>
            <button class="button" id="execBtn">斷詞</button>

          </div>

          <div class="segResult">
            <div class="resultText" id="resultSeg"></div>
          </div>

          <div class="listTitle">
            <h3>未處理標籤</h3>
            <button class="button" id="queryBtn">查詢</button>
          </div>
          <div class="segTitle">
            <div class="titleName">名稱</div>
            <div class="titleCount">數量</div>
            <div class="titleTag">標籤</div>
          </div>
          <div class="segContent scrollBar" id="segResults">

            <!-- <div class="segList">
              <div class="tagName">口罩</div>
              <div class="count">321</div>
              <input type="text" class="inputTag">
            </div> -->

          </div>
          <div class="segEnd">
            <div class="segResult">
              <div class="resultText" id="resultTag"></div>
            </div>
            <button class="button" id="updateBtn">送出</button>
          </div>

        </div>
      </div>

    </main>

    <footer>

    </footer>

    <script>

      const execBtn = document.getElementById("execBtn");
      const queryBtn = document.getElementById("queryBtn");
      const updateBtn = document.getElementById("updateBtn");

      const date_start = document.getElementById("date_start");
      const date_end = document.getElementById("date_end");
      const resultSeg = document.getElementById("resultSeg");
      const resultTag = document.getElementById("resultTag");


      const segResults = document.getElementById("segResults");


      // 執行新聞斷詞
      execBtn.addEventListener('click', function(event) {
        resultSeg.innerHTML = "斷詞中...";
        resultSeg.style.color = "red";
        resultSeg.style.display = "block";
        let data = {
          start: date_start.value,
          end: date_end.value,
        }
        segNews(data);
      });

      // 撈出未處理標籤
      queryBtn.addEventListener('click', function(event) {
        removeData();
        querySegs();
      })

      // 更新標籤
      updateBtn.addEventListener('click', function(event) {
        const tagNames = document.querySelectorAll(".tagName");
        const inputTags = document.querySelectorAll(".inputTag");

        let data = [];
        for(let i = 0; i < tagNames.length; i ++) {

          let body = {
            tagName: tagNames[i].innerText,
            inputTag: inputTags[i].value
          }

          data.push(body);
        }
        resultTag.innerHTML = "標籤更新中";
        resultTag.style.color = "red";
        resultTag.style.display = "block";
        updateTagStatus(data);
      })






      // Seg news
      function segNews(data) {
        console.log(data);
        $.ajax({
          url: "admin/api/seg",
          type: "POST",
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8", // 送給 server 的格式
          success: function(resp) {
            console.log(resp);
            resultSeg.innerHTML = "斷詞處理完成";
            resultSeg.style.color = "blue";
            resultSeg.style.display = "block";
          }
        });
      }

      // Get data
      function querySegs() {
        $.ajax({
          url: "admin/api/list",
          type: "GET",
          success: function(resp) {
            listForm(resp);
          }
        });
      }

      // Update tag status & dict
      function updateTagStatus(data) {
        $.ajax({
          url: "admin/api/updateDB",
          type: "POST",
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8", // 送給 server 的格式
          success: function(resp) {
            console.log(resp);
            removeData();
            resultTag.innerHTML = "標籤更新完成";
            resultTag.style.color = "blue";
            resultTag.style.display = "block";
          }
        });
      }

      function listForm(results) {

        for(let i = 0; i < results.data.length; i++) {
          var segListDiv = document.createElement("div");
          segListDiv.className = "segList";

          var tagNameDiv = document.createElement("div");
          tagNameDiv.className = "tagName";
          tagNameDiv.innerHTML = results.data[i].tagName;

          var countDiv = document.createElement("div");
          countDiv.className = "count";
          countDiv.innerHTML = results.data[i].count;

          var inputTag = document.createElement("input");
          inputTag.className = "inputTag";
          inputTag.setAttribute("type", "text");

          segListDiv.appendChild(tagNameDiv);
          segListDiv.appendChild(countDiv);
          segListDiv.appendChild(inputTag);

          segResults.appendChild(segListDiv);
        }
      }

      function removeData() {
        var child = segResults.lastElementChild;
        while(child) {
          segResults.removeChild(child);
          child = segResults.lastElementChild;
        }
      }


    </script>

  </body>


</html>
`
