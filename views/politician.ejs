<!DOCTYPE html>
<html lang="en">

  <head>
      <title>Politician Track</title>
      <link rel="shortcut icon" href="#"/>
      <link rel="stylesheet" type="text/css" href="./css/common.css">
      <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
  </head>

  <body>

    <header>
      <div class="logo">
        <a href="./">Politician Track</a>
      </div>
      <nav>
        <div class="item">
          <a href="./politician">篩選</a>
        </div>
        <div class="item">
          <a href="./hots">熱門</a>
        </div>
      </nav>
      <div class="feature">
        <a href="./about">About Us</a>
      </div>
    </header>



    <main>

      <div class="sidenav">
        <div class="filters">
          <ul>
            <li class="filter" id="main">主選</li>
            <li class="filter" id="party">政黨</li>
            <li class="filter" id="region">地區</li>
            <!-- <li class="filter" id="time">時間</li> -->
          </ul>
        </div>
        <div class="partyList filterItems scrollBar">
          <ul>
            <li class="party">中國國民黨</li>
            <li class="party">民主進步黨</li>
            <li class="party">台灣民眾黨</li>
            <li class="party">時代力量</li>
            <li class="party">台灣基進</li>
            <li class="party">親民黨</li>
            <li class="party">無黨團結聯盟</li>
            <li class="party">台灣團結聯盟</li>
            <li class="party">國會政黨聯盟</li>
            <li class="party">綠黨</li>
            <li class="party">勞動黨</li>
            <li class="party">新黨</li>
            <li class="party">中華民族致公黨</li>
            <li class="party">社會民主黨</li>
          </ul>
        </div>
        <div class="regionList filterItems scrollBar">
          <ul>
            <li class="region">臺北市</li>
            <li class="region">新北市</li>
            <li class="region">桃園市</li>
            <li class="region">臺中市</li>
            <li class="region">臺南市</li>
            <li class="region">高雄市</li>
            <li class="region">基隆市</li>
            <li class="region">新竹市</li>
            <li class="region">嘉義市</li>
            <li class="region">新竹縣</li>
            <li class="region">苗栗縣</li>
            <li class="region">彰化縣</li>
            <li class="region">南投縣</li>
            <li class="region">雲林縣</li>
            <li class="region">嘉義縣</li>
            <li class="region">屏東縣</li>
            <li class="region">宜蘭縣</li>
            <li class="region">花蓮縣</li>
            <li class="region">臺東縣</li>
            <li class="region">澎湖縣</li>
            <li class="region">金門縣</li>
            <li class="region">連江縣</li>
          </ul>
        </div>
        <div class="mainFilter filterItems">
          <div class="politician">
            <ul id="appendPols">
              <li class="personTitle">人物</li>
              <div class="box-border"></div>
              <div class="inner scrollBar">
                <% polsData.forEach(function(result){ %>
                  <li class="person"><%= result.name %></li>
                <% }); %>
                <!-- <li class="person">韓國瑜</li> -->
              </div>
            </ul>
          </div>
          <div class="issueList scrollBar">
            <ul>
              <li class="issueTitle">議題</li>
              <div class="box-border"></div>
              <div class="inner scrollBar">
                <% issuesData.forEach(function(result){ %>
                  <li class="issue"><%= result.name %></li>
                <% }); %>
                <li class="issue">一個中國</li>
              </div>
            </ul>
          </div>
        </div>

      </div>

      <div class="content">

        <div class="top" id="defaultTop">

          <div class="titleName" id="titleName"><%= title %></div>
          <br>
          <div class="titleIssue" id="titleIssue"><%= issue %></div>

        </div>

        <div class="top" id="compareTop">

        </div>

        <div class="newslist scrollBar" id="oncomingNews">
          <ul class="ulNews">
            <% for(let i = 0; i < results.length; i++) { %>
            <li>
              <div class="timeline">
              <% var renderTime = new Date(results[i].pubTime); %>
              <% if(i > 0) { %>
                <% var renderPreTime = new Date(results[i - 1].pubTime); %>

                <% var renderPreTimeY = renderPreTime.getFullYear(); %>
                <% var renderPreTimeM = renderPreTime.getMonth(); %>
                <% var renderCurTimeY = renderTime.getFullYear(); %>
                <% var renderCurTimeM = renderTime.getMonth(); %>

                <% if(renderPreTimeY !== renderCurTimeY && renderPreTimeM !== renderCurTimeM) { %>
                  <p class="year"><%= renderTime.getFullYear() %></p>
                  <p class="month"><%= (renderTime.getMonth() < 10 ? '0' : '') + (renderTime.getMonth() + 1) %></p>
                <% } else if (renderPreTimeY == renderCurTimeY && renderPreTimeM !== renderCurTimeM) { %>
                  <p class="year"><%= "" %></p>
                  <p class="month"><%= (renderTime.getMonth() < 10 ? '0' : '') + (renderTime.getMonth() + 1) %></p>
                <% } else { %>
                  <p class="year"><%= "" %></p>
                  <p class="month"><%= "" %></p>
                <% } %>
              <% } else { %>
                <p class="year"><%= renderTime.getFullYear() %></p>
                <p class="month"><%= (renderTime.getMonth() < 10 ? '0' : '') + (renderTime.getMonth() + 1) %></p>
              <% } %>
              </div>
              <div class="news">
                <div class="news-content">
                  <a href="<%= results[i].href %>" target="_blank">
                    <div class="title"><%= results[i].title %></div>
                    <div class="publisher"><%= results[i].publisher %></div>
                    <div class="pubTime"><%= results[i].pubTime %></div>
                    <div class="desc">
                      <p><%= results[i].description %></p>
                    </div>
                  </a>
                </div> <!-- news-content End -->
              </div> <!-- news End -->
              <div class="renderTags">
                <ul>
                  <% for(let j = 0; j < results[i].tag.length && j < 5; j++) { %>
                    <% if(results[i].tag[j].tagType === "NRP") { %>
                      <li class="polTag" onclick="tagCallPol('<%=results[i].tag[j].tagName%>')"><%= results[i].tag[j].tagName %></li>
                    <% } else { %>
                      <li class="issueTag" onclick="tagCallIssue('<%=results[i].tag[j].tagName%>')"><%= results[i].tag[j].tagName %></li>
                    <% } %>
                  <% } %>
                </ul>
              </div>
            </li>
            <% }; %>
          </ul>
        </div> <!-- NewsList End -->

        <div class="newslist scrollBar" id="appendNewsP">
          <ul class="ulNews" id="appendNews">

          </ul>
        </div>
      </div> <!-- Content End -->

    </main>

    <footer>

    </footer>

  <script>

    const filters = document.querySelectorAll('.filter');
    const filterItems = document.querySelectorAll('.filterItems');
    const mainFilter = document.querySelector('.mainFilter');
    const partyList = document.querySelector('.partyList');
    const regionList = document.querySelector('.regionList');

    const people = document.querySelectorAll('.person');
    const issues = document.querySelectorAll('.issue');
    const parties = document.querySelectorAll('.party');
    const regions = document.querySelectorAll('.region');

    const defaultTop = document.getElementById("defaultTop");
    const compareTop = document.getElementById("compareTop");
    const appendNewsP = document.getElementById("appendNewsP");
    const appendNews = document.getElementById("appendNews");
    const appendPols = document.getElementById('appendPols');

    let name = '';
    let issueName = '';

    // sidenav 選擇處理
    filters.forEach(filter => filter.addEventListener('click', function(event) {
      let chooseFilter = event.target.id;

      if(this.classList.contains("highlight")) {

        this.classList.remove("highlight");
        switch(chooseFilter) {
          case "main":
            mainFilter.style.display = "none";

            let nameList = [];
            let condList = [];
            let issueName;
            let issueNameTitle;
            people.forEach(function(person) {
              if(person.classList.contains("innerHighlight")) {
                nameList.push(person.innerText);
                condList.push(person.innerText);
              }
            });
            issueName = "";
            issueNameTitle = "總覽";
            issues.forEach(function(issue) {
              if(issue.classList.contains("innerHighlight")) {
                issueName = issue.innerText;
                issueNameTitle = issue.innerText;
                condList.push(issue.innerText);
              }
            });
            if(nameList.length > 1) {
              defaultTop.style.display = "none";
              compareTop.style.display = "flex";
              removeData(compareTop);
              getCompare(condList, [condList[0],condList[1]], condList[2]);
            } else {
              defaultTop.style.display = "";
              compareTop.style.display = "none";
            }
            break;
          case "party":
            partyList.style.display = "none";
            break;
          case "region":
            regionList.style.display = "none";
            break;
          default:
        }
        tagShow()
      } else {
        // filters.forEach(r => r.classList.remove("highlight"));
        this.classList.add("highlight");
        // filterItems.forEach(filterItem => filterItem.style.display = "none");
        switch(chooseFilter) {
          case "main":
            mainFilter.style.display = "flex";

            nameList = [];
            issueName;
            people.forEach(function(person) {
              if(person.classList.contains("innerHighlight")) {
                nameList.push(person.innerText);
              }
            });
            issues.forEach(function(issue) {
              if(issue.classList.contains("innerHighlight")) {
                issueName = issue.innerText;
              }
            });
            if(nameList.length > 1) {
              defaultTop.style.display = "";
              compareTop.style.display = "none";
              removeData(compareTop);
              getData(nameList, issueName);
            } else {
              defaultTop.style.display = "";
              // document.getElementById("titleName").innerHTML = "總覽";
              // document.getElementById("titleIssue").innerHTML = "";
            }
            break;
          case "party":
            partyList.style.display = "block";
            break;
          case "region":
            regionList.style.display = "block";
            break;
          default:
        }
        tagShow()
      }
    }));

    let firstPolName;
    let firstPolClass;
    let oldFirstPolName;
    let oldFirstPolClass;
    // 人物選擇處理
    people.forEach(person => person.addEventListener('click', function(event) {
      // console.log("這一輪的 first: " + firstPolName + " " + firstPolClass);

      if(this.classList.contains("innerHighlight")) {
        if(this.innerText === oldFirstPolName) {
          this.classList.remove("innerHighlight");
          oldFirstPolName = "";
          firstPolName = "";
        } else {
          this.classList.remove("innerHighlight");
          firstPolName = oldFirstPolName;
          firstPolClass = oldFirstPolClass;
        }
      } else {
        if(firstPolName) {
          oldFirstPolName = firstPolName;
          oldFirstPolClass = firstPolClass;
          people.forEach(r => r.classList.remove("innerHighlight"));
          firstPolClass.add("innerHighlight");
          this.classList.add("innerHighlight");
        } else {
          this.classList.add("innerHighlight");
        }
        firstPolName = event.target.innerText;
        firstPolClass = event.target.classList;
      }
      if(!oldFirstPolName && !firstPolName) {
        document.getElementById("titleName").innerHTML = "總覽";
        document.getElementById("titleIssue").innerHTML = "";
      }

      // console.log("舊: " + oldFirstPolName + " " + oldFirstPolClass);
      // console.log("下一輪的 first: " + firstPolName + " " + firstPolClass);
      // console.log("=======");

      // let nameList = polSelect();
      getData(polSelect(), issueName);
    }));

    // 議題選擇處理
    issues.forEach(issue => issue.addEventListener('click', function(event) {
      if(this.classList.contains("innerHighlight")) {
        this.classList.remove("innerHighlight");
      } else {
        issues.forEach(r => r.classList.remove("innerHighlight"));
        this.classList.add("innerHighlight");
      }
      issueName = toggle(issueName, event);
      getData(polSelect(), issueName);
    }));

    // 新聞旁標籤點選切換
    function tagCallPol(name) {
      getData(name, issueName);
    }

    function tagCallIssue(issueName) {
      getData('', issueName);
    }


    childFilter(parties);
    childFilter(regions);

    // 子 filter 處理
    function childFilter(items) {
      items.forEach(item => item.addEventListener('click', function() {
        if(this.classList.contains("innerHighlight")) {
          this.classList.remove("innerHighlight");
        } else {
          this.classList.add("innerHighlight");
        }
      }));
    }

    // DB 取資料
    function getData(name, issueName) {
      $.ajax({
        url: `/api/news/listtag?name=${name}\&issue=${issueName}`,
        method: "GET",
        // data: name,
        dataType: 'json',
        contentType: "application/json",
        success: function(resp) {
          // console.log(resp);
          removeData(appendNews);
          changeTitle(name);
          changeIssue(issueName);
          dataForm(name, resp);
          tagShow()
        }
      });
    }

    // Get compare DB data
    function getCompare(data, titleName, titleIssue) {
      $.ajax({
        url: "api/news/gggg",
        type: "POST",
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8", // 送給 server 的格式
        success: function(resp) {
          removeData(appendNews);
          changeCompareTitle(titleName,titleIssue);
          dataCompareForm(name, resp, titleName);
          tagShow()
        }
      });
    }

    // 移除重複點擊
    function toggle(condition, events) {
      if(!condition) {
        condition = event.target.innerText;
      } else {
        if(condition === event.target.innerText) {
          condition = '';
        } else {
          condition = event.target.innerText;
        }
      }
      return condition;
    }

    function changeTitle(name) {
      var titleName = document.getElementById("titleName");
      titleName.innerHTML = name;
    }

    function changeIssue(issueName) {
      var titleIssue = document.getElementById("titleIssue");
      titleIssue.innerHTML = issueName;
    }

    function changeCompareTitle(titleName,titleIssue) {

      let compareTitleName = document.createElement("div");
      compareTitleName.className = "titleName";
      compareTitleName.innerHTML = titleName[0];

      let compareTitleIssue = document.createElement("div");
      compareTitleIssue.className = "titleIssue";
      compareTitleIssue.innerHTML = titleIssue;

      let compareTitleName2 = document.createElement("div");
      compareTitleName2.className = "titleName";
      compareTitleName2.innerHTML = titleName[1];

      compareTop.appendChild(compareTitleName);
      compareTop.appendChild(compareTitleIssue);
      compareTop.appendChild(compareTitleName2);
    }

    function dataForm(name, results) {
      document.getElementById('oncomingNews').style.display = "none";
      document.getElementById('appendNewsP').style.display = "flex";

      for (let i = 0; i < results.data.length; i ++) {
        var li = document.createElement("li");

        // timeline
        var timelineDiv = document.createElement("div");
        timelineDiv.className = "timeline";

        var time = new Date(results.data[i].pubTime);

        var yearP = document.createElement("p");
        var monthP = document.createElement("p");
        yearP.className = "year";
        monthP.className = "month";

        if(i > 0) {
          var preTime = new Date(results.data[i - 1].pubTime);

          var preTimeY = preTime.getFullYear();
          var preTimeM = preTime.getMonth();
          var curTimeY = time.getFullYear();
          var curTimeM = time.getMonth();

          if(preTimeY !== curTimeY && preTimeM !== curTimeM) {
            yearP.innerHTML = time.getFullYear();
            monthP.innerHTML = (time.getMonth() < 10 ? '0' : '') + (time.getMonth() + 1);
          } else if (preTimeY == curTimeY && preTimeM !== curTimeM) {
            yearP.innerHTML = "";
            monthP.innerHTML = (time.getMonth() < 10 ? '0' : '') + (time.getMonth() + 1);
          } else {
            yearP.innerHTML = "";
            monthP.innerHTML = "";
          }
        } else {
          yearP.innerHTML = time.getFullYear();
          monthP.innerHTML = (time.getMonth() < 10 ? '0' : '') + (time.getMonth() + 1);
        }

        timelineDiv.appendChild(yearP);
        timelineDiv.appendChild(monthP);

        // news
        var newsDiv = document.createElement("div");
        newsDiv.className = "news";

        var newsContentDiv = document.createElement("div");
        newsContentDiv.className = "news-content";

        var link = document.createElement("a");
        link.setAttribute("href", `${results.data[i].href}`);
        link.setAttribute("target", "_blank");

        var titleDiv = document.createElement("div");
        titleDiv.className = "title";
        titleDiv.innerHTML = results.data[i].title;

        var publisherDiv = document.createElement("div");
        publisherDiv.className = "publisher";
        publisherDiv.innerHTML = results.data[i].publisher;

        var pubTimeDiv = document.createElement("div");
        pubTimeDiv.className = "pubTime";
        pubTimeDiv.innerHTML = results.data[i].pubTime;

        var descDiv = document.createElement("div");
        descDiv.className = "desc";

        var descP = document.createElement("p");
        descP.innerHTML = results.data[i].description;

        descDiv.appendChild(descP);
        link.appendChild(titleDiv);
        link.appendChild(publisherDiv);
        link.appendChild(pubTimeDiv);
        link.appendChild(descDiv);

        newsContentDiv.appendChild(link);
        newsDiv.appendChild(newsContentDiv);

        // tags
        var tagsDiv = document.createElement("div");
        tagsDiv.className = "newsTags";

        var tagUl = document.createElement("ul");

        for(let j = 0; j < results.data[i].tag.length && j < 5; j++) {
          var tagLi = document.createElement("li");
          if(results.data[i].tag[j].tagName != name) {
            tagLi.innerHTML = results.data[i].tag[j].tagName;
            if(results.data[i].tag[j].tagType === "NRP") {
              tagLi.className = "polTag";
              tagLi.setAttribute("onclick", `tagCallPol("${results.data[i].tag[j].tagName}")`);
            } else {
              tagLi.className = "issueTag";
              tagLi.setAttribute("onclick", `tagCallIssue("${results.data[i].tag[j].tagName}")`);
            }
            tagUl.appendChild(tagLi);
          }
        }
        tagsDiv.appendChild(tagUl);

        // 組合
        li.appendChild(timelineDiv);
        li.appendChild(newsDiv);
        li.appendChild(tagsDiv);

        appendNews.appendChild(li);
      }
    }

    function dataCompareForm(name, results, titleName) {
      document.getElementById('oncomingNews').style.display = "none";
      document.getElementById('appendNewsP').style.display = "flex";


      for (let i = 0; i < results.data.length; i ++) {
        // timeDivide
        var timeDivideDiv = document.createElement("div");
        timeDivideDiv.className = "timeDivide";

        var timeDivideSpan = document.createElement("span");

        var time = new Date(results.data[i].pubTime);

        if(i > 0) {
          var preRawTime = new Date(results.data[i - 1].pubTime);

          var preTime = preRawTime.getFullYear() + " / " + (preRawTime.getMonth() < 10 ? '0' : '') + (preRawTime.getMonth() + 1);
          var curTime = time.getFullYear() + " / " + (time.getMonth() < 10 ? '0' : '') + (time.getMonth() + 1);

          if(preTime !== curTime) {
            timeDivideSpan.innerHTML = curTime;
            timeDivideDiv.appendChild(timeDivideSpan);
          } else {
            timeDivideDiv.style.display = "none";
          }
        } else {
          timeDivideSpan.innerHTML = time.getFullYear() + " / " + (time.getMonth() < 10 ? '0' : '') + (time.getMonth() + 1);
          timeDivideDiv.appendChild(timeDivideSpan);
        }

        appendNews.appendChild(timeDivideDiv);

        var li = document.createElement("li");


        // news
        var newsDiv = document.createElement("div");
        if(results.data[i].tag_id === titleName[0]) {
          li.className = "left";
          newsDiv.className = "news leftnews";
        } else if (results.data[i].tag_id === titleName[1]) {
          li.className = "right";
          newsDiv.className = "news rightnews";
        } else {
          li.className = "center";
          newsDiv.className = "news centernews";
        }

        var newsContentDiv = document.createElement("div");
        newsContentDiv.className = "news-content";

        var link = document.createElement("a");
        link.setAttribute("href", `${results.data[i].href}`);
        link.setAttribute("target", "_blank");

        var titleDiv = document.createElement("div");
        titleDiv.className = "title";
        titleDiv.innerHTML = results.data[i].title;

        var publisherDiv = document.createElement("div");
        publisherDiv.className = "publisher";
        publisherDiv.innerHTML = results.data[i].publisher;

        var pubTimeDiv = document.createElement("div");
        pubTimeDiv.className = "pubTime";
        pubTimeDiv.innerHTML = results.data[i].pubTime;

        var descDiv = document.createElement("div");
        descDiv.className = "desc";

        var descP = document.createElement("p");
        descP.innerHTML = results.data[i].content;

        descDiv.appendChild(descP);
        link.appendChild(titleDiv);
        link.appendChild(publisherDiv);
        link.appendChild(pubTimeDiv);
        link.appendChild(descDiv);

        newsContentDiv.appendChild(link);
        newsDiv.appendChild(newsContentDiv);

        // 組合
        li.appendChild(newsDiv);

        appendNews.appendChild(li);
      }
    }

    function removeData(item) {
      var child = item.lastElementChild;
      while(child) {
        item.removeChild(child);
        child = item.lastElementChild;
      }
    }

    function tagShow() {

      let tagJudge = document.getElementsByClassName("content")[0].offsetWidth;
      let tagsShow = document.querySelectorAll(".newsTags");
      let renderTagsShow = document.querySelectorAll(".renderTags");

      if(document.querySelectorAll(".newsTags") && tagJudge > 1150) {
        tagsShow.forEach(tagShow => tagShow.style.display = "block");
      } else if (document.querySelectorAll(".newsTags") && tagJudge < 1151) {
        tagsShow.forEach(tagShow => tagShow.style.display = "none");
      }
      if(document.querySelectorAll(".renderTags") && tagJudge > 1150) {
        renderTagsShow.forEach(tagShow => tagShow.style.display = "block");
      } else if (document.querySelectorAll(".renderTags") && tagJudge < 1151) {
        renderTagsShow.forEach(tagShow => tagShow.style.display = "none");
      }
    }

    // 偵測是否選兩個
    function polSelect() {
      let nameList = [];
      people.forEach(function(person) {
        if(person.classList.contains("innerHighlight")) {
          nameList.push(person.innerText);
        }
      });
      return nameList;
    }




  </script>

  </body>


</html>
